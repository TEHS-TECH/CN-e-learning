# å¤šæ ¡è”ç›Ÿæ•°æ®åŒæ­¥éªŒè¯å·¥ä½œæµ
name: å¤šæ ¡è”ç›Ÿæ•°æ®åŒæ­¥éªŒè¯

on:
  # å®šæ—¶æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹ï¼‰
  schedule:
    - cron: '0 2 * * *'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # å½“æ•°æ®æ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶è§¦å‘
  push:
    paths:
      - 'docs/school/**/*.json'
      - 'docs/public/school/**/*.json'
    branches: [ main, master ]

# è®¾ç½®å¿…è¦çš„æƒé™
permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  validate-and-sync-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: åˆ›å»ºæ•°æ®éªŒè¯è„šæœ¬
        run: |
          cat > validate-data.js << 'EOF'
          const fs = require('fs');
          const path = require('path');

          /**
           * éªŒè¯å¤šæ ¡è”ç›Ÿæ•°æ®ä¸€è‡´æ€§
           */
          function validateDataConsistency() {
            const devHeatmapPath = 'docs/school/heatmap-data.json';
            const publicHeatmapPath = 'docs/public/school/heatmap-data.json';
            const devProvincePath = 'docs/school/province-data.json';
            const publicProvincePath = 'docs/public/school/province-data.json';
            
            const issues = [];
            
            try {
              // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
              if (!fs.existsSync(devHeatmapPath)) {
                issues.push(`âŒ ç¼ºå¤±æ–‡ä»¶: ${devHeatmapPath}`);
              }
              if (!fs.existsSync(publicHeatmapPath)) {
                issues.push(`âŒ ç¼ºå¤±æ–‡ä»¶: ${publicHeatmapPath}`);
              }
              if (!fs.existsSync(devProvincePath)) {
                issues.push(`âŒ ç¼ºå¤±æ–‡ä»¶: ${devProvincePath}`);
              }
              if (!fs.existsSync(publicProvincePath)) {
                issues.push(`âŒ ç¼ºå¤±æ–‡ä»¶: ${publicProvincePath}`);
              }
              
              if (issues.length > 0) {
                return { valid: false, issues };
              }
              
              // è¯»å–æ•°æ®æ–‡ä»¶
              const devHeatmap = JSON.parse(fs.readFileSync(devHeatmapPath, 'utf8'));
              const publicHeatmap = JSON.parse(fs.readFileSync(publicHeatmapPath, 'utf8'));
              const devProvince = JSON.parse(fs.readFileSync(devProvincePath, 'utf8'));
              const publicProvince = JSON.parse(fs.readFileSync(publicProvincePath, 'utf8'));
              
              // éªŒè¯å­¦æ ¡æ€»æ•°ä¸€è‡´æ€§
              if (devHeatmap.totalSchools !== publicHeatmap.totalSchools) {
                issues.push(`âŒ å­¦æ ¡æ€»æ•°ä¸ä¸€è‡´: dev(${devHeatmap.totalSchools}) vs public(${publicHeatmap.totalSchools})`);
              }
              
              if (devProvince.totalSchools !== publicProvince.totalSchools) {
                issues.push(`âŒ çœä»½æ•°æ®å­¦æ ¡æ€»æ•°ä¸ä¸€è‡´: dev(${devProvince.totalSchools}) vs public(${publicProvince.totalSchools})`);
              }
              
              // éªŒè¯çœä»½æ•°æ®ä¸€è‡´æ€§
              const devProvinces = Object.keys(devProvince.provinces);
              const publicProvinces = Object.keys(publicProvince.provinces);
              
              if (devProvinces.length !== publicProvinces.length) {
                issues.push(`âŒ çœä»½æ•°é‡ä¸ä¸€è‡´: dev(${devProvinces.length}) vs public(${publicProvinces.length})`);
              }
              
              // éªŒè¯æ¯ä¸ªçœä»½çš„å­¦æ ¡æ•°é‡
              for (const provinceCode of devProvinces) {
                const devCount = devProvince.provinces[provinceCode]?.count || 0;
                const publicCount = publicProvince.provinces[provinceCode]?.count || 0;
                
                if (devCount !== publicCount) {
                  const provinceName = devProvince.provinces[provinceCode]?.name || provinceCode;
                  issues.push(`âŒ ${provinceName}å­¦æ ¡æ•°é‡ä¸ä¸€è‡´: dev(${devCount}) vs public(${publicCount})`);
                }
              }
              
              // éªŒè¯çƒ­åŠ›å›¾æ•°æ®çœä»½æ•°é‡
              if (devHeatmap.data.length !== publicHeatmap.data.length) {
                issues.push(`âŒ çƒ­åŠ›å›¾çœä»½æ•°é‡ä¸ä¸€è‡´: dev(${devHeatmap.data.length}) vs public(${publicHeatmap.data.length})`);
              }
              
              console.log('âœ… æ•°æ®éªŒè¯å®Œæˆ');
              if (issues.length === 0) {
                console.log('âœ… æ‰€æœ‰æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡');
                return { valid: true, issues: [] };
              } else {
                console.log('âŒ å‘ç°æ•°æ®ä¸ä¸€è‡´é—®é¢˜:');
                issues.forEach(issue => console.log(`  ${issue}`));
                return { valid: false, issues };
              }
              
            } catch (error) {
              issues.push(`âŒ éªŒè¯è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`);
              return { valid: false, issues };
            }
          }

          /**
           * åŒæ­¥æ•°æ®æ–‡ä»¶
           */
          function syncDataFiles() {
            try {
              const devHeatmapPath = 'docs/school/heatmap-data.json';
              const publicHeatmapPath = 'docs/public/school/heatmap-data.json';
              const devProvincePath = 'docs/school/province-data.json';
              const publicProvincePath = 'docs/public/school/province-data.json';
              const devMappingPath = 'docs/school/province-mapping.json';
              const publicMappingPath = 'docs/public/school/province-mapping.json';
              
              // ç¡®ä¿publicç›®å½•å­˜åœ¨
              const publicDir = path.dirname(publicHeatmapPath);
              if (!fs.existsSync(publicDir)) {
                fs.mkdirSync(publicDir, { recursive: true });
              }
              
              // åŒæ­¥æ–‡ä»¶ï¼ˆä»¥devç¯å¢ƒä¸ºå‡†ï¼‰
              if (fs.existsSync(devHeatmapPath)) {
                fs.copyFileSync(devHeatmapPath, publicHeatmapPath);
                console.log('âœ… å·²åŒæ­¥ heatmap-data.json');
              }
              
              if (fs.existsSync(devProvincePath)) {
                fs.copyFileSync(devProvincePath, publicProvincePath);
                console.log('âœ… å·²åŒæ­¥ province-data.json');
              }
              
              if (fs.existsSync(devMappingPath)) {
                fs.copyFileSync(devMappingPath, publicMappingPath);
                console.log('âœ… å·²åŒæ­¥ province-mapping.json');
              }
              
              return true;
            } catch (error) {
              console.error('âŒ åŒæ­¥å¤±è´¥:', error.message);
              return false;
            }
          }

          // ä¸»æ‰§è¡Œé€»è¾‘
          const validation = validateDataConsistency();
          
          if (!validation.valid) {
            console.log('ğŸ”„ æ£€æµ‹åˆ°æ•°æ®ä¸ä¸€è‡´ï¼Œå¼€å§‹è‡ªåŠ¨åŒæ­¥...');
            const syncSuccess = syncDataFiles();
            
            if (syncSuccess) {
              console.log('âœ… æ•°æ®åŒæ­¥å®Œæˆ');
              // é‡æ–°éªŒè¯
              const revalidation = validateDataConsistency();
              if (revalidation.valid) {
                console.log('âœ… åŒæ­¥åéªŒè¯é€šè¿‡');
                process.exit(0);
              } else {
                console.log('âŒ åŒæ­¥åä»å­˜åœ¨é—®é¢˜');
                process.exit(1);
              }
            } else {
              console.log('âŒ æ•°æ®åŒæ­¥å¤±è´¥');
              process.exit(1);
            }
          } else {
            console.log('âœ… æ•°æ®ä¸€è‡´æ€§éªŒè¯é€šè¿‡ï¼Œæ— éœ€åŒæ­¥');
            process.exit(0);
          }
          EOF

      - name: æ‰§è¡Œæ•°æ®éªŒè¯å’ŒåŒæ­¥
        id: validate
        run: |
          node validate-data.js
          echo "validation_result=$?" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
        id: check_changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: æäº¤åŒæ­¥åçš„æ–‡ä»¶
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/public/school/
          git commit -m "ğŸ”„ è‡ªåŠ¨åŒæ­¥å¤šæ ¡è”ç›Ÿæ•°æ®æ–‡ä»¶

          - åŒæ­¥ heatmap-data.json
          - åŒæ­¥ province-data.json  
          - åŒæ­¥ province-mapping.json
          
          ç¡®ä¿ public å’Œ dev ç¯å¢ƒæ•°æ®ä¸€è‡´æ€§"
          git push

      - name: åˆ›å»ºé—®é¢˜æŠ¥å‘Šï¼ˆå¦‚æœéªŒè¯å¤±è´¥ï¼‰
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = 'ğŸš¨ å¤šæ ¡è”ç›Ÿæ•°æ®ä¸€è‡´æ€§éªŒè¯å¤±è´¥';
            const body = `
            ## æ•°æ®ä¸€è‡´æ€§éªŒè¯å¤±è´¥

            **è§¦å‘æ—¶é—´**: ${new Date().toISOString()}
            **å·¥ä½œæµ**: ${context.workflow}
            **è¿è¡ŒID**: ${context.runId}

            ### é—®é¢˜æè¿°
            å¤šæ ¡è”ç›Ÿæ•°æ®åœ¨ public å’Œ dev ç¯å¢ƒä¹‹é—´å­˜åœ¨ä¸ä¸€è‡´é—®é¢˜ã€‚

            ### éœ€è¦æ£€æŸ¥çš„æ–‡ä»¶
            - \`docs/school/heatmap-data.json\`
            - \`docs/public/school/heatmap-data.json\`
            - \`docs/school/province-data.json\`
            - \`docs/public/school/province-data.json\`
            - \`docs/school/province-mapping.json\`
            - \`docs/public/school/province-mapping.json\`

            ### å»ºè®®æ“ä½œ
            1. æ£€æŸ¥ä¸Šè¿°æ–‡ä»¶çš„æ•°æ®ä¸€è‡´æ€§
            2. æ‰‹åŠ¨è¿è¡Œæ•°æ®åŒæ­¥å·¥ä½œæµ
            3. å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·è”ç³»ç»´æŠ¤äººå‘˜

            ### ç›¸å…³é“¾æ¥
            - [å·¥ä½œæµè¿è¡Œè¯¦æƒ…](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            `;

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„é—®é¢˜
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['æ•°æ®åŒæ­¥', 'è‡ªåŠ¨åŒ–']
            });

            const existingIssue = issues.find(issue => issue.title === title);

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['æ•°æ®åŒæ­¥', 'è‡ªåŠ¨åŒ–', 'bug']
              });
              console.log('å·²åˆ›å»ºé—®é¢˜æŠ¥å‘Š');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `ğŸ”„ **${new Date().toISOString()}** å†æ¬¡æ£€æµ‹åˆ°æ•°æ®ä¸ä¸€è‡´é—®é¢˜\n\n[æŸ¥çœ‹æœ€æ–°è¿è¡Œè¯¦æƒ…](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
              });
              console.log('å·²æ›´æ–°ç°æœ‰é—®é¢˜æŠ¥å‘Š');
            }

  # æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ä»»åŠ¡
  data-integrity-check:
    runs-on: ubuntu-latest
    needs: validate-and-sync-data
    if: always()
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
        run: |
          echo "ğŸ” æ‰§è¡Œæ•°æ®å®Œæ•´æ€§æ£€æŸ¥..."
          
          # æ£€æŸ¥å¿…è¦çš„æ•°æ®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          files=(
            "docs/school/heatmap-data.json"
            "docs/public/school/heatmap-data.json"
            "docs/school/province-data.json"
            "docs/public/school/province-data.json"
            "docs/school/province-mapping.json"
            "docs/public/school/province-mapping.json"
          )
          
          missing_files=()
          for file in "${files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
            fi
          done
          
          if [ ${#missing_files[@]} -eq 0 ]; then
            echo "âœ… æ‰€æœ‰å¿…è¦çš„æ•°æ®æ–‡ä»¶éƒ½å­˜åœ¨"
          else
            echo "âŒ ç¼ºå¤±ä»¥ä¸‹æ–‡ä»¶:"
            printf '%s\n' "${missing_files[@]}"
            exit 1
          fi
          
          # æ£€æŸ¥JSONæ–‡ä»¶æ ¼å¼
          echo "ğŸ” æ£€æŸ¥JSONæ–‡ä»¶æ ¼å¼..."
          for file in "${files[@]}"; do
            if [ -f "$file" ]; then
              if jq empty "$file" 2>/dev/null; then
                echo "âœ… $file æ ¼å¼æ­£ç¡®"
              else
                echo "âŒ $file æ ¼å¼é”™è¯¯"
                exit 1
              fi
            fi
          done
          
          echo "âœ… æ•°æ®å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡"