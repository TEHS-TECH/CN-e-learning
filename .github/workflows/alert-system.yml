# å¤šæ ¡è”ç›Ÿæ•°æ®å¼‚å¸¸å‘Šè­¦ç³»ç»Ÿ
name: æ•°æ®å¼‚å¸¸å‘Šè­¦ç³»ç»Ÿ

on:
  # å½“æ•°æ®åŒæ­¥éªŒè¯å¤±è´¥æ—¶è§¦å‘
  workflow_run:
    workflows: ["å¤šæ ¡è”ç›Ÿæ•°æ®åŒæ­¥éªŒè¯"]
    types:
      - completed
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      alert_type:
        description: 'å‘Šè­¦ç±»å‹'
        required: true
        default: 'data_inconsistency'
        type: choice
        options:
        - data_inconsistency
        - sync_failure
        - validation_error
      message:
        description: 'è‡ªå®šä¹‰å‘Šè­¦æ¶ˆæ¯'
        required: false
        type: string

# è®¾ç½®å¿…è¦çš„æƒé™
permissions:
  contents: read
  issues: write
  discussions: write

jobs:
  check-workflow-status:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'failure'
    outputs:
      should_alert: ${{ steps.check.outputs.should_alert }}
      alert_level: ${{ steps.check.outputs.alert_level }}
      
    steps:
      - name: æ£€æŸ¥å·¥ä½œæµçŠ¶æ€
        id: check
        run: |
          echo "å·¥ä½œæµ '${{ github.event.workflow_run.name }}' æ‰§è¡Œå¤±è´¥"
          echo "ç»“è®º: ${{ github.event.workflow_run.conclusion }}"
          echo "should_alert=true" >> $GITHUB_OUTPUT
          echo "alert_level=high" >> $GITHUB_OUTPUT

  send-alerts:
    runs-on: ubuntu-latest
    needs: [check-workflow-status]
    if: always() && (needs.check-workflow-status.outputs.should_alert == 'true' || github.event_name == 'workflow_dispatch')
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ç”Ÿæˆå‘Šè­¦ä¿¡æ¯
        id: generate_alert
        run: |
          # è®¾ç½®å‘Šè­¦ä¿¡æ¯
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ALERT_TYPE="${{ github.event.inputs.alert_type }}"
            CUSTOM_MESSAGE="${{ github.event.inputs.message }}"
          else
            ALERT_TYPE="workflow_failure"
            CUSTOM_MESSAGE="å·¥ä½œæµæ‰§è¡Œå¤±è´¥: ${{ github.event.workflow_run.name }}"
          fi
          
          # ç”Ÿæˆå‘Šè­¦æ ‡é¢˜å’Œå†…å®¹
          case $ALERT_TYPE in
            "data_inconsistency")
              TITLE="ğŸš¨ æ•°æ®ä¸ä¸€è‡´å‘Šè­¦"
              PRIORITY="high"
              LABELS="æ•°æ®åŒæ­¥,å‘Šè­¦,é«˜ä¼˜å…ˆçº§"
              ;;
            "sync_failure")
              TITLE="âš ï¸ æ•°æ®åŒæ­¥å¤±è´¥å‘Šè­¦"
              PRIORITY="medium"
              LABELS="æ•°æ®åŒæ­¥,å‘Šè­¦,ä¸­ä¼˜å…ˆçº§"
              ;;
            "validation_error")
              TITLE="âŒ æ•°æ®éªŒè¯é”™è¯¯å‘Šè­¦"
              PRIORITY="medium"
              LABELS="æ•°æ®éªŒè¯,å‘Šè­¦,ä¸­ä¼˜å…ˆçº§"
              ;;
            "workflow_failure")
              TITLE="ğŸ”§ å·¥ä½œæµæ‰§è¡Œå¤±è´¥å‘Šè­¦"
              PRIORITY="high"
              LABELS="å·¥ä½œæµ,å‘Šè­¦,é«˜ä¼˜å…ˆçº§"
              ;;
            *)
              TITLE="ğŸ”” ç³»ç»Ÿå‘Šè­¦"
              PRIORITY="low"
              LABELS="ç³»ç»Ÿ,å‘Šè­¦"
              ;;
          esac
          
          echo "alert_title=$TITLE" >> $GITHUB_OUTPUT
          echo "alert_type=$ALERT_TYPE" >> $GITHUB_OUTPUT
          echo "priority=$PRIORITY" >> $GITHUB_OUTPUT
          echo "labels=$LABELS" >> $GITHUB_OUTPUT
          echo "custom_message=$CUSTOM_MESSAGE" >> $GITHUB_OUTPUT

      - name: åˆ›å»ºæˆ–æ›´æ–°å‘Šè­¦Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = '${{ steps.generate_alert.outputs.alert_title }}';
            const alertType = '${{ steps.generate_alert.outputs.alert_type }}';
            const priority = '${{ steps.generate_alert.outputs.priority }}';
            const labels = '${{ steps.generate_alert.outputs.labels }}'.split(',');
            const customMessage = '${{ steps.generate_alert.outputs.custom_message }}';
            
            // ç”Ÿæˆå‘Šè­¦å†…å®¹
            const currentTime = new Date().toISOString();
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            let body = `## å‘Šè­¦è¯¦æƒ…\n\n`;
            body += `**å‘Šè­¦æ—¶é—´**: ${currentTime}\n`;
            body += `**å‘Šè­¦ç±»å‹**: ${alertType}\n`;
            body += `**ä¼˜å…ˆçº§**: ${priority}\n`;
            body += `**è§¦å‘æ–¹å¼**: ${context.eventName}\n\n`;
            
            if (customMessage) {
              body += `**è¯¦ç»†ä¿¡æ¯**: ${customMessage}\n\n`;
            }
            
            // æ ¹æ®å‘Šè­¦ç±»å‹æ·»åŠ å…·ä½“ä¿¡æ¯
            switch (alertType) {
              case 'data_inconsistency':
                body += `### æ•°æ®ä¸ä¸€è‡´é—®é¢˜\n\n`;
                body += `æ£€æµ‹åˆ°å¤šæ ¡è”ç›Ÿæ•°æ®åœ¨ public å’Œ dev ç¯å¢ƒä¹‹é—´å­˜åœ¨ä¸ä¸€è‡´ã€‚\n\n`;
                body += `#### éœ€è¦æ£€æŸ¥çš„æ–‡ä»¶\n`;
                body += `- \`docs/school/heatmap-data.json\` vs \`docs/public/school/heatmap-data.json\`\n`;
                body += `- \`docs/school/province-data.json\` vs \`docs/public/school/province-data.json\`\n`;
                body += `- \`docs/school/province-mapping.json\` vs \`docs/public/school/province-mapping.json\`\n\n`;
                body += `#### å»ºè®®æ“ä½œ\n`;
                body += `1. è¿è¡Œæ•°æ®éªŒè¯è„šæœ¬: \`pnpm run validate:data\`\n`;
                body += `2. å¦‚æœ‰é—®é¢˜ï¼Œè¿è¡Œæ•°æ®åŒæ­¥: \`pnpm run sync:data\`\n`;
                body += `3. æ£€æŸ¥æœ€æ–°çš„æ•°æ®åŒæ­¥å·¥ä½œæµæ‰§è¡Œæƒ…å†µ\n`;
                break;
                
              case 'sync_failure':
                body += `### æ•°æ®åŒæ­¥å¤±è´¥\n\n`;
                body += `è‡ªåŠ¨æ•°æ®åŒæ­¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ã€‚\n\n`;
                body += `#### å¯èƒ½åŸå› \n`;
                body += `- æºæ–‡ä»¶æ ¼å¼é”™è¯¯æˆ–æŸå\n`;
                body += `- æ–‡ä»¶æƒé™é—®é¢˜\n`;
                body += `- ç½‘ç»œæˆ–ç³»ç»Ÿä¸´æ—¶æ•…éšœ\n\n`;
                body += `#### å»ºè®®æ“ä½œ\n`;
                body += `1. æ£€æŸ¥æºæ•°æ®æ–‡ä»¶çš„å®Œæ•´æ€§\n`;
                body += `2. æ‰‹åŠ¨è¿è¡ŒåŒæ­¥è„šæœ¬è¿›è¡Œè¯Šæ–­\n`;
                body += `3. æŸ¥çœ‹è¯¦ç»†çš„é”™è¯¯æ—¥å¿—\n`;
                break;
                
              case 'validation_error':
                body += `### æ•°æ®éªŒè¯é”™è¯¯\n\n`;
                body += `æ•°æ®æ–‡ä»¶éªŒè¯è¿‡ç¨‹ä¸­å‘ç°é”™è¯¯ã€‚\n\n`;
                body += `#### å¯èƒ½é—®é¢˜\n`;
                body += `- JSONæ ¼å¼é”™è¯¯\n`;
                body += `- æ•°æ®ç»“æ„ä¸ç¬¦åˆé¢„æœŸ\n`;
                body += `- å¿…è¦å­—æ®µç¼ºå¤±\n\n`;
                body += `#### å»ºè®®æ“ä½œ\n`;
                body += `1. æ£€æŸ¥æ•°æ®æ–‡ä»¶çš„JSONæ ¼å¼\n`;
                body += `2. éªŒè¯æ•°æ®ç»“æ„çš„å®Œæ•´æ€§\n`;
                body += `3. å¯¹æ¯”æ­£ç¡®çš„æ•°æ®æ¨¡æ¿\n`;
                break;
                
              case 'workflow_failure':
                body += `### å·¥ä½œæµæ‰§è¡Œå¤±è´¥\n\n`;
                body += `GitHub Actions å·¥ä½œæµæ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ã€‚\n\n`;
                if (context.payload.workflow_run) {
                  body += `**å¤±è´¥çš„å·¥ä½œæµ**: ${context.payload.workflow_run.name}\n`;
                  body += `**å·¥ä½œæµURL**: ${context.payload.workflow_run.html_url}\n\n`;
                }
                body += `#### å»ºè®®æ“ä½œ\n`;
                body += `1. æŸ¥çœ‹å·¥ä½œæµçš„è¯¦ç»†æ—¥å¿—\n`;
                body += `2. æ£€æŸ¥ç›¸å…³çš„ä»£ç å˜æ›´\n`;
                body += `3. éªŒè¯å·¥ä½œæµé…ç½®çš„æ­£ç¡®æ€§\n`;
                break;
            }
            
            body += `\n### ç›¸å…³é“¾æ¥\n`;
            body += `- [å½“å‰å‘Šè­¦å·¥ä½œæµ](${runUrl})\n`;
            body += `- [æ•°æ®éªŒè¯è„šæœ¬](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/scripts/validate-data-consistency.js)\n`;
            body += `- [æ•°æ®åŒæ­¥è„šæœ¬](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/scripts/sync-data-files.js)\n\n`;
            
            body += `---\n`;
            body += `*æ­¤å‘Šè­¦ç”±è‡ªåŠ¨åŒ–ç³»ç»Ÿç”Ÿæˆï¼Œå¦‚éœ€å¸®åŠ©è¯·è”ç³»ç»´æŠ¤å›¢é˜Ÿã€‚*`;
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒç±»å‹çš„å¼€æ”¾å‘Šè­¦
            const { data: existingIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: labels[0] // ä½¿ç”¨ç¬¬ä¸€ä¸ªæ ‡ç­¾è¿›è¡Œç­›é€‰
            });
            
            const existingAlert = existingIssues.find(issue => 
              issue.title.includes(alertType) && 
              issue.labels.some(label => label.name === 'å‘Šè­¦')
            );
            
            if (existingAlert) {
              // æ›´æ–°ç°æœ‰å‘Šè­¦
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingAlert.number,
                body: `ğŸ”„ **${currentTime}** å†æ¬¡è§¦å‘å‘Šè­¦\n\n${customMessage ? `**è¯¦æƒ…**: ${customMessage}\n\n` : ''}[æŸ¥çœ‹æœ€æ–°æ‰§è¡Œè¯¦æƒ…](${runUrl})`
              });
              
              // æ›´æ–°æ ‡ç­¾ï¼ˆå¦‚æœä¼˜å…ˆçº§æ›´é«˜ï¼‰
              if (priority === 'high') {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingAlert.number,
                  labels: ['é«˜ä¼˜å…ˆçº§']
                });
              }
              
              console.log(`å·²æ›´æ–°ç°æœ‰å‘Šè­¦ Issue #${existingAlert.number}`);
            } else {
              // åˆ›å»ºæ–°çš„å‘Šè­¦Issue
              const newIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: labels
              });
              
              console.log(`å·²åˆ›å»ºæ–°çš„å‘Šè­¦ Issue #${newIssue.data.number}`);
            }

      - name: å‘é€é€šçŸ¥åˆ°è®¨è®ºåŒº
        if: steps.generate_alert.outputs.priority == 'high'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = '${{ steps.generate_alert.outputs.alert_title }}';
            const alertType = '${{ steps.generate_alert.outputs.alert_type }}';
            const customMessage = '${{ steps.generate_alert.outputs.custom_message }}';
            const currentTime = new Date().toISOString();
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            const body = `## ğŸš¨ é«˜ä¼˜å…ˆçº§ç³»ç»Ÿå‘Šè­¦\n\n` +
                        `**æ—¶é—´**: ${currentTime}\n` +
                        `**ç±»å‹**: ${alertType}\n` +
                        `**è¯¦æƒ…**: ${customMessage}\n\n` +
                        `è¯·ç›¸å…³ç»´æŠ¤äººå‘˜åŠæ—¶å¤„ç†ã€‚\n\n` +
                        `[æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯](${runUrl})`;
            
            try {
              // å°è¯•åœ¨è®¨è®ºåŒºå‘å¸ƒé€šçŸ¥ï¼ˆéœ€è¦ä»“åº“å¯ç”¨è®¨è®ºåŠŸèƒ½ï¼‰
              const { data: categories } = await github.rest.repos.listDiscussionCategories({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              
              const announcementCategory = categories.find(cat => 
                cat.name.toLowerCase().includes('announcement') || 
                cat.name.toLowerCase().includes('é€šçŸ¥')
              );
              
              if (announcementCategory) {
                await github.rest.repos.createDiscussion({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: title,
                  body: body,
                  category_id: announcementCategory.id
                });
                console.log('å·²åœ¨è®¨è®ºåŒºå‘å¸ƒé«˜ä¼˜å…ˆçº§å‘Šè­¦é€šçŸ¥');
              }
            } catch (error) {
              console.log('æ— æ³•åœ¨è®¨è®ºåŒºå‘å¸ƒé€šçŸ¥ï¼ˆå¯èƒ½æœªå¯ç”¨è®¨è®ºåŠŸèƒ½ï¼‰:', error.message);
            }

  cleanup-resolved-alerts:
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: æ¸…ç†å·²è§£å†³çš„å‘Šè­¦
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // æŸ¥æ‰¾æ‰€æœ‰å¼€æ”¾çš„å‘Šè­¦Issue
            const { data: alertIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'å‘Šè­¦'
            });
            
            console.log(`æ‰¾åˆ° ${alertIssues.length} ä¸ªå¼€æ”¾çš„å‘Šè­¦Issue`);
            
            // æ£€æŸ¥å‘Šè­¦æ˜¯å¦å·²è§£å†³ï¼ˆè¶…è¿‡24å°æ—¶ä¸”æ— æ–°æ´»åŠ¨ï¼‰
            const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
            
            for (const issue of alertIssues) {
              const updatedAt = new Date(issue.updated_at);
              
              if (updatedAt < oneDayAgo) {
                // æ·»åŠ è¯„è®ºå¹¶å…³é—­Issue
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: 'ğŸ”„ æ­¤å‘Šè­¦å·²è¶…è¿‡24å°æ—¶æ— æ–°æ´»åŠ¨ï¼Œç³»ç»Ÿè‡ªåŠ¨å…³é—­ã€‚å¦‚é—®é¢˜ä»å­˜åœ¨ï¼Œè¯·é‡æ–°æ‰“å¼€æ­¤Issueã€‚'
                });
                
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed',
                  labels: [...issue.labels.map(l => l.name), 'è‡ªåŠ¨å…³é—­']
                });
                
                console.log(`å·²è‡ªåŠ¨å…³é—­å‘Šè­¦Issue #${issue.number}`);
              }
            }